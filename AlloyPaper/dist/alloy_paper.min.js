/* Alloy Game Engine
 * By AlloyTeam http://www.alloyteam.com/
 * Github: https://github.com/AlloyTeam/AlloyGameEngine
 * MIT Licensed.
 */
!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.AlloyPaper=e()}(this,function(){"use strict";var t=function(){};t.extend=function(e){function i(){this.ctor.apply(this,arguments)}var n=this.prototype,s=Object.create(n);for(var h in e)"statics"!=h&&(s[h]="function"==typeof e[h]&&"function"==typeof n[h]?function(t,e){return function(){var i=this._super;this._super=n[t];var s=e.apply(this,arguments);return this._super=i,s}}(h,e[h]):e[h]);for(var r in this)this.hasOwnProperty(r)&&"extend"!=r&&(i[r]=this[r]);if(i.prototype=s,i.prototype._super=Object.create(n),e.statics)for(var r in e.statics)e.statics.hasOwnProperty(r)&&(i[r]=e.statics[r],"ctor"==r&&i[r]());return i.prototype.constructor=i,i.extend=t.extend,i},window.Class=t;var e={};return e.DefaultCursor="default",e.Cache={},e.Matrix2D=t.extend({statics:{DEG_TO_RAD:.017453292519943295},ctor:function(t,e,i,n,s,h){return this.a=null==t?1:t,this.b=e||0,this.c=i||0,this.d=null==n?1:n,this.tx=s||0,this.ty=h||0,this},identity:function(){return this.a=this.d=1,this.b=this.c=this.tx=this.ty=0,this},appendTransform:function(t,i,n,s,h,r,a,o,c){if(h%360)var l=h*e.Matrix2D.DEG_TO_RAD,u=Math.cos(l),d=Math.sin(l);else u=1,d=0;return r||a?(r*=e.Matrix2D.DEG_TO_RAD,a*=e.Matrix2D.DEG_TO_RAD,this.append(Math.cos(a),Math.sin(a),-Math.sin(r),Math.cos(r),t,i),this.append(u*n,d*n,-d*s,u*s,0,0)):this.append(u*n,d*n,-d*s,u*s,t,i),(o||c)&&(this.tx-=o*this.a+c*this.c,this.ty-=o*this.b+c*this.d),this},append:function(t,e,i,n,s,h){var r=this.a,a=this.b,o=this.c,c=this.d;return this.a=t*r+e*o,this.b=t*a+e*c,this.c=i*r+n*o,this.d=i*a+n*c,this.tx=s*r+h*o+this.tx,this.ty=s*a+h*c+this.ty,this},initialize:function(t,e,i,n,s,h){return this.a=t,this.b=e,this.c=i,this.d=n,this.tx=s,this.ty=h,this},setValues:function(t,e,i,n,s,h){return this.a=null==t?1:t,this.b=e||0,this.c=i||0,this.d=null==n?1:n,this.tx=s||0,this.ty=h||0,this},copy:function(t){return this.setValues(t.a,t.b,t.c,t.d,t.tx,t.ty)}}),e.UID={},e.UID._nextID=0,e.UID._nextCacheID=1,e.UID.get=function(){return this._nextID++},e.UID.getCacheID=function(){return this._nextCacheID++},e.Renderer=t.extend({ctor:function(t,i){this.stage=t,this.objs=[],this.width=this.stage.width,this.height=this.stage.height,this.mainCanvas=this.stage.canvas;var n=!!window.CanvasRenderingContext2D,s=function(){try{var t=document.createElement("canvas");return!(!window.WebGLRenderingContext||!t.getContext("webgl")&&!t.getContext("experimental-webgl"))}catch(e){return!1}}();if(s&&i)this.renderingEngine=new e.WebGLRenderer(this.stage.canvas);else{if(!n)throw"your browser does not support canvas and webgl ";this.renderingEngine=new e.CanvasRenderer(this.stage.canvas)}this.mainCtx=this.renderingEngine.ctx},update:function(){var t=this.objs,e=this.mainCtx,i=this.renderingEngine;t.length=0,this.computeMatrix(),i.clear();for(var n=t.length,s=0;n>s;s++)i.renderObj(e,t[s])},computeMatrix:function(){for(var t=0,e=this.stage.children.length;e>t;t++)this._computeMatrix(this.stage.children[t])},initComplex:function(t){t.complexCompositeOperation=this._getCompositeOperation(t),t.complexAlpha=this._getAlpha(t,1)},_computeMatrix:function(t,i){if(t.isVisible())if(i?t._matrix.initialize(i.a,i.b,i.c,i.d,i.tx,i.ty):t._matrix.initialize(1,0,0,1,0,0),t instanceof e.Shape?t._matrix.appendTransform(t.x,t.y,1,1,t.rotation,t.skewX,t.skewY,t.regX,t.regY):t._matrix.appendTransform(t.x,t.y,t.scaleX,t.scaleY,t.rotation,t.skewX,t.skewY,t.regX,t.regY),t instanceof e.Container)for(var n=t.children,s=n.length,h=0;s>h;h++)this._computeMatrix(n[h],t._matrix);else t instanceof e.Graphics||t instanceof e.Text?(this.objs.push(t),this.initComplex(t)):(t.initAABB(),this.isInStage(t)&&(this.objs.push(t),this.initComplex(t)))},_getCompositeOperation:function(t){return t.compositeOperation?t.compositeOperation:t.parent?this._getCompositeOperation(t.parent):void 0},_getAlpha:function(t,e){var i=t.alpha*e;return t.parent?this._getAlpha(t.parent,i):i},isInStage:function(t){return this.collisionBetweenAABB(t.AABB,this.stage.AABB)},collisionBetweenAABB:function(t,e){var i=t[0]+t[2];if(i<e[0])return!1;var n=t[0];if(n>e[0]+e[2])return!1;var s=t[1]+t[3];if(s<e[1])return!1;var h=t[1];return!(h>e[1]+e[3])}}),e.CanvasRenderer=t.extend({ctor:function(t){t&&(this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.height=this.canvas.height,this.width=this.canvas.width)},hitAABB:function(t,e,i,n){for(var s=e.children.slice(0),h=s.length,r=h-1;r>=0;r--){var a=s[r];if(this.isbindingEvent(a)){var o=this._hitAABB(t,a,i,n);if(o)return o}}},_hitAABB:function(t,i,n,s){if(i.isVisible())if(i instanceof e.Container)for(var h=i.children.slice(0),r=h.length,a=r-1;a>=0;a--){var o=h[a],c=this._hitAABB(t,o,n,s);if(c)return c}else if(i.AABB&&this.checkPointInAABB(n.stageX,n.stageY,i.AABB))return this._bubbleEvent(i,s,n),i},hitRender:function(t,e,i,n){for(var s=e._hitMatrix,h=e.children.slice(0),r=h.length,a=r-1;a>=0;a--){var o=h[a];if(s.initialize(1,0,0,1,0,0),s.appendTransform(e.x-i.stageX,e.y-i.stageY,e.scaleX,e.scaleY,e.rotation,e.skewX,e.skewY,e.regX,e.regY),this.isbindingEvent(o)){t.save();var c=this._hitRender(t,o,s,i,n);if(t.restore(),c)return c}}},_hitRender:function(t,i,n,s,h){if(t.clearRect(0,0,2,2),i.isVisible()){n?i._hitMatrix.initialize(n.a,n.b,n.c,n.d,n.tx,n.ty):i._hitMatrix.initialize(1,0,0,1,0,0),n=i._hitMatrix,i instanceof e.Shape?n.appendTransform(i.x,i.y,1,1,i.rotation,i.skewX,i.skewY,i.regX,i.regY):n.appendTransform(i.x,i.y,i.scaleX,i.scaleY,i.rotation,i.skewX,i.skewY,i.regX,i.regY);var r=i.cacheCanvas||i.txtCanvas||i.shapeCanvas;if(r)t.globalAlpha=i.complexAlpha,t.globalCompositeOperation=i.complexCompositeOperation,t.setTransform(n.a,n.b,n.c,n.d,n.tx,n.ty),t.drawImage(r,0,0);else if(i instanceof e.Container)for(var a=i.children.slice(0),o=a.length,c=o-1;c>=0;c--){t.save();var l=this._hitRender(t,a[c],n,s,h);if(l)return l;t.restore()}else if(i instanceof e.Bitmap||i instanceof e.Sprite){t.globalAlpha=i.complexAlpha,t.globalCompositeOperation=i.complexCompositeOperation;var u=i.rect;t.setTransform(n.a,n.b,n.c,n.d,n.tx,n.ty),t.drawImage(i.img,u[0],u[1],u[2],u[3],0,0,u[2],u[3])}else i instanceof e.Graphics&&(t.setTransform(n.a,n.b,n.c,n.d,n.tx,n.ty),i.draw(t));return t.getImageData(0,0,1,1).data[3]>1&&!(i instanceof e.Container)?(this._bubbleEvent(i,h,s),i):void 0}},_bubbleEvent:function(t,e,i){var n=t.execEvent(e,i);n!==!1&&t.parent&&t.parent.events&&t.parent.events[e]&&t.parent.events[e].length>0&&"Stage"!==t.parent.baseInstanceof&&this._bubbleEvent(t.parent,e,i)},isbindingEvent:function(t){if(0!==Object.keys(t.events).length)return!0;if(t instanceof e.Container)for(var i=0,n=t.children.length;n>i;i++){var s=t.children[i];if(s instanceof e.Container)return this.isbindingEvent(s);if(0!==Object.keys(s.events).length)return!0}return!1},clear:function(){this.ctx.clearRect(0,0,this.width,this.height)},renderObj:function(t,i){var n=i._matrix;t.save(),t.globalAlpha=i.complexAlpha,t.globalCompositeOperation=i.complexCompositeOperation,i.shadow&&this._applyShadow(t,i.shadow);var s=i.cacheCanvas||i.txtCanvas||i.shapeCanvas;if(s)t.setTransform(n.a,n.b,n.c,n.d,n.tx,n.ty),t.drawImage(s,0,0);else if(i instanceof e.Bitmap||i instanceof e.Sprite){i._clipFn&&(t.beginPath(),i._clipFn.call(t),t.closePath(),t.clip());var h=i.rect;t.setTransform(n.a,n.b,n.c,n.d,n.tx,n.ty),t.drawImage(i.img,h[0],h[1],h[2],h[3],0,0,h[2],h[3])}else(i instanceof e.Graphics||i instanceof e.Text)&&(t.setTransform(n.a,n.b,n.c,n.d,n.tx,n.ty),i.draw(t));t.restore()},_applyShadow:function(t,e){t.shadowColor=e.color||"transparent",t.shadowOffsetX=e.offsetX||0,t.shadowOffsetY=e.offsetY||0,t.shadowBlur=e.blur||0},clearBackUpCanvasCache:function(){},checkPointInAABB:function(t,e,i){var n=i[0];if(n>t)return!1;var s=i[1];if(s>e)return!1;var h=n+i[2];if(t>h)return!1;var r=s+i[3];return!(e>r)}}),e.DisplayObject=t.extend({ctor:function(){this.alpha=this.scaleX=this.scaleY=this.scale=1,this.x=this.y=this.rotation=this.originX=this.originY=this.skewX=this.skewY=this.width=this.height=this.regX=this.regY=0,this.textureReady=!0,this.visible=!0,this._matrix=new e.Matrix2D,this._hitMatrix=new e.Matrix2D,this.events={},this.id=e.UID.get(),this.cacheID=0,this.baseInstanceof="DisplayObject",this.tickFPS=60;var t=this;this._watch(this,"originX",function(e,i){"string"==typeof i?t.regX=parseInt(i):t.regX=t.width*i}),this._watch(this,"originY",function(e,i){"string"==typeof i?t.regY=parseInt(i):t.regY=t.height*i}),this._watch(this,"filter",function(e,i){t.setFilter.apply(t,i)}),this._watch(this,"scale",function(t,e){this.scaleX=this.scaleY=this.scale}),this.cursor="default",this.onHover(function(){},function(){this._setCursor(this,e.DefaultCursor)})},_watch:function(t,e,i){if("string"==typeof e)t["__"+e]=this[e],Object.defineProperty(t,e,{get:function(){return this["__"+e]},set:function(n){this["__"+e]=n,i.apply(t,[e,n])}});else for(var n=0,s=e.length;s>n;n++){var h=e[n];t["__"+h]=this[h],function(e){Object.defineProperty(t,e,{get:function(){return this["__"+e]},set:function(n){this["__"+e]=n,i.apply(t,[e,n])}})}(h)}},isVisible:function(){return!!(this.visible&&this.alpha>0&&0!=this.scaleX&&0!=this.scaleY&&this.textureReady)},on:function(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)},off:function(t,e){var i=this.events[t];if(i)for(var n=0,s=i.length;s>n;n++)if(i[n]===e){i.splice(n,1);break}},execEvent:function(t,e){if(this.events){var i=this.events[t],n=!0;if(i)for(var s=0,h=i.length;h>s;s++)n=i[s].call(this,e);return n}},_setCursor:function(t,i){t&&(t.parent instanceof e.Stage?t.parent.setCursor(i):this._setCursor(t.parent,i))},clone:function(){var t=new e.DisplayObject;return this.cloneProps(t),t},cloneProps:function(t){t.visible=this.visible,t.alpha=this.alpha,t.originX=this.originX,t.originY=this.originY,t.rotation=this.rotation,t.scaleX=this.scaleX,t.scaleY=this.scaleY,t.skewX=this.skewX,t.skewY=this.skewY,t.x=this.x,t.y=this.y,t.regX=this.regX,t.regY=this.regY},cache:function(){if(!this.cacheCanvas){this.cacheCanvas=document.createElement("canvas");var t=this.getBound();this.cacheCanvas.width=t.width,this.cacheCanvas.height=t.height,this.cacheCtx=this.cacheCanvas.getContext("2d")}this.cacheID=e.UID.getCacheID(),this.updateCache(this.cacheCtx,this,t.width,t.width)},uncache:function(){this.cacheCanvas=null,this.cacheCtx=null,this.cacheID=null},setFilter:function(t,e,i,n){if(0!==this.width&&0!==this.height){this.uncache(),this.cache();for(var s=this.cacheCtx.getImageData(0,0,this.cacheCanvas.width,this.cacheCanvas.height),h=s.data,r=0,a=h.length;a>r;r+=4)h[r+3]>0&&(h[r]*=t,h[r+1]*=e,h[r+2]*=i,h[r+3]*=n);this.cacheCtx.putImageData(s,0,0)}},getBound:function(){return{width:this.width,height:this.height}},toCenter:function(){this.originX=.5,this.originY=.5,this.x=this.parent.width/2,this.y=this.parent.height/2},destroy:function(){this.cacheCanvas=null,this.cacheCtx=null,this.cacheID=null,this._matrix=null,this.events=null,this.parent&&this.parent.remove(this)},initAABB:function(){var t,e,i=this.width,n=this.height,s=this._matrix,h=i*s.a,r=i*s.b,a=n*s.c,o=n*s.d,c=s.tx,l=s.ty,u=c,d=c,f=l,p=l;(t=h+c)<u?u=t:t>d&&(d=t),(t=h+a+c)<u?u=t:t>d&&(d=t),(t=a+c)<u?u=t:t>d&&(d=t),(e=r+l)<f?f=e:e>p&&(p=e),(e=r+o+l)<f?f=e:e>p&&(p=e),(e=o+l)<f?f=e:e>p&&(p=e),this.AABB=[u,f,d-u,p-f],this.rectPoints=[{x:c,y:l},{x:h+c,y:r+l},{x:h+a+c,y:r+o+l},{x:a+c,y:o+l}]},updateCache:function(t,e,i,n){t.clearRect(0,0,i+1,n+1),this.renderCache(t,e)},renderCache:function(t,i){if(i.isVisible())if(i instanceof e.Container||i instanceof e.Stage)for(var n=i.children.slice(0),s=0,h=n.length;h>s;s++)t.save(),this.render(t,n[s]),t.restore();else if(i instanceof e.Bitmap||i instanceof e.Sprite){var r=i.rect;t.drawImage(i.img,r[0],r[1],r[2],r[3],0,0,r[2],r[3])}else i.txtCanvas?t.drawImage(i.txtCanvas,0,0):i.shapeCanvas&&t.drawImage(i.shapeCanvas,0,0)},onClick:function(t){this.on("click",t)},onMouseDown:function(t){this.on("pressdown",t)},onMouseMove:function(t){this.on("mousemove",t)},onMouseUp:function(t){this.on("pressup",t)},onMouseOver:function(t){this.on("mouseover",t)},onMouseOut:function(t){this.on("mouseout",t)},onHover:function(t,e){this.on("mouseover",t),this.on("mouseout",e)},onPressDown:function(t){this.on("pressdown",t)},onPressMove:function(t){this.on("pressmove",t)},onPressUp:function(t){this.on("pressup",t)},onMouseWheel:function(t){this.on("mousewheel",t)},onTouchStart:function(t){this.on("pressdown",t)},onTouchMove:function(t){this.on("pressmove",t)},onTouchEnd:function(t){this.on("pressup",t)},onTouchCancel:function(){this.on("touchcancel",fn)},onDbClick:function(t){this.on("dblclick",t)},addEventListener:function(t,e){this.on(this._normalizeEventType(t),e)},removeEventListener:function(t,e){this.off(this._normalizeEventType(t),e)},_normalizeEventType:function(t){var e={touchstart:"pressdown",touchmove:"pressmove",touchend:"pressup"}[t];return e?e:t}}),e.Bitmap=e.DisplayObject.extend({ctor:function(t){this._super(),Object.defineProperty(this,"rect",{get:function(){return this.__rect},set:function(t){this.__rect=t,this.width=t[2],this.height=t[3],this.regX=t[2]*this.originX,this.regY=t[3]*this.originY}}),0!==arguments.length&&("string"==typeof t?(this._initWithSrc(t),this.imgSrc=t):(this._init(t),this.imgSrc=t.src))},_initWithSrc:function(t){var i=e.Cache[t];if(i)this._init(i);else{var n=this;this.textureReady=!1,this.img=document.createElement("img"),this.img.crossOrigin="Anonymous",this.img.onload=function(){n.rect||(n.rect=[0,0,n.img.width,n.img.height]),e.Cache[t]=n.img,n.textureReady=!0,n.imageLoadHandle&&n.imageLoadHandle(),n.filter&&(n.filter=n.filter)},this.img.src=t}},_init:function(t){t&&(this.img=t,this.img.crossOrigin="Anonymous",this.width=t.width,this.height=t.height,this.rect=[0,0,t.width,t.height])},useImage:function(t){"string"==typeof t?this._initWithSrc(t):(this._init(t),this.imageLoadHandle&&this.imageLoadHandle())},onImageLoad:function(t){this.imageLoadHandle=t},clone:function(){if(this.textureReady){var t=new e.Bitmap(this.img);return t.rect=this.rect.slice(0),this.cloneProps(t),t}var t=new e.Bitmap(this.imgSrc);return this.rect&&(t.rect=this.rect.slice(0)),this.cloneProps(t),t},clip:function(t){this._clipFn=t},flipX:function(){},flipY:function(){}}),e.Container=e.DisplayObject.extend({ctor:function(){this._super(),this.children=[],this.baseInstanceof="Container"},add:function(t){var e=arguments.length;if(e>1)for(var i=0;e>i;i++){var n=arguments[i];n&&(this.children.push(n),n.parent=this)}else t&&(this.children.push(t),t.parent=this)},remove:function(t){var e=arguments.length,i=this.children.length;if(e>1){for(var n=0;e>n;n++)for(var s=arguments[n],h=i;--h>=0;)if(s&&this.children[h].id==s.id){s.parent=null,this.children.splice(h,1);break}}else for(var r=i;--r>=0;)if(t&&this.children[r].id==t.id){t.parent=null,this.children.splice(r,1);break}},clone:function(){var t=new e.Container;this.cloneProps(t);for(var i=t.children=[],n=this.children.length-1;n>-1;n--){var s=this.children[n].clone();i.unshift(s)}return t},removeAll:function(){for(var t=this.children;t.length;)t.pop().parent=null},destroy:function(){this._super();for(var t=this.children;t.length;){var e=t.pop();e.destroy(),e=null}},swapChildrenAt:function(t,e){var i=this.children,n=i[t],s=i[e];n&&s&&(i[t]=s,i[e]=n)},swapChildren:function(t,e){for(var i,n,s=this.children,h=0,r=s.length;r>h&&(s[h]==t&&(i=h),s[h]==e&&(n=h),null==i||null==n);h++);h!=r&&(s[i]=e,s[n]=t)},swapToTop:function(t){this.swapChildren(t,this.children[this.children.length-1])}}),e.Graphics=e.DisplayObject.extend({ctor:function(){this._super(),this.cmds=[],this.assMethod=["fillStyle","strokeStyle","lineWidth"]},draw:function(t){for(var e=0,i=this.cmds.length;i>e;e++){var n=this.cmds[e];this.assMethod.join("-").match(new RegExp("\\b"+n[0]+"\\b","g"))?t[n[0]]=n[1][0]:t[n[0]].apply(t,Array.prototype.slice.call(n[1]))}},clearRect:function(t,e,i,n){return this.cmds.push(["clearRect",arguments]),this},clear:function(){return this.cmds.length=0,this},strokeRect:function(){return this.cmds.push(["strokeRect",arguments]),this},fillRect:function(){return this.cmds.push(["fillRect",arguments]),this},beginPath:function(){return this.cmds.push(["beginPath",arguments]),this},arc:function(){return this.cmds.push(["arc",arguments]),this},closePath:function(){return this.cmds.push(["closePath",arguments]),this},fillStyle:function(){return this.cmds.push(["fillStyle",arguments]),this},fill:function(){return this.cmds.push(["fill",arguments]),this},strokeStyle:function(){return this.cmds.push(["strokeStyle",arguments]),this},lineWidth:function(){return this.cmds.push(["lineWidth",arguments]),this},stroke:function(){return this.cmds.push(["stroke",arguments]),this},moveTo:function(){return this.cmds.push(["moveTo",arguments]),this},lineTo:function(){return this.cmds.push(["lineTo",arguments]),this},bezierCurveTo:function(){return this.cmds.push(["bezierCurveTo",arguments]),this},clone:function(){}}),e.Label=e.DisplayObject.extend({ctor:function(t){this._super(),this.value=t.value,this.fontSize=t.fontSize,this.fontFamily=t.fontFamily,this.color=t.color,this.textAlign="center",this.textBaseline="top",this.fontWeight=t.fontWeight||"",this.maxWidth=t.maxWidth||2e3,this.square=t.square||!1,this.txtCanvas=document.createElement("canvas"),this.txtCtx=this.txtCanvas.getContext("2d"),this.setDrawOption(),this.shadow=t.shadow,this._watch(this,["value","fontSize","color","fontFamily"],function(){this.setDrawOption()})},setDrawOption:function(){var t=this.getDrawOption({txt:this.value,maxWidth:this.maxWidth,square:this.square,size:this.fontSize,alignment:this.textAlign,color:this.color||"black",fontFamily:this.fontFamily,fontWeight:this.fontWeight,shadow:this.shadow});this.cacheID=e.UID.getCacheID(),this.width=t.calculatedWidth,this.height=t.calculatedHeight},getDrawOption:function(t){var e,i,n,s,h=this.txtCanvas,r=this.txtCtx,a=[],o=t.txt,c=t.maxWidth,l=t.square,u=t.size,d=t.alignment,f=t.color,p=t.fontFamily,v=t.fontWeight;switch(r.font=u+"px "+p,c&&this.measureText(r,o)>c?(c=this.createMultilineText(r,o,c,a),e=this.getPowerOfTwo(c)):(a.push(o),e=this.getPowerOfTwo(r.measureText(o).width)),i=this.getPowerOfTwo(u*(a.length+1)),l&&(e>i?i=e:e=i),t.calculatedWidth=e,t.calculatedHeight=i,h.width=e,h.height=i,d){case"left":n=0;break;case"center":n=e/2;break;case"right":n=e}s=i/2,r.fillStyle=f,r.textAlign=d,r.textBaseline="middle",r.font=v+" "+u+"px "+p,t.shadow&&(r.shadowColor=t.shadow.color||"transparent",r.shadowOffsetX=t.shadow.offsetX||0,r.shadowOffsetY=t.shadow.offsetY||0,r.shadowBlur=t.shadow.blur||0);var g=.5*(i-u*(a.length+1));t.cmd=[];for(var m=0;m<a.length;m++)a.length>1&&(s=(m+1)*u+g),t.cmd.push({text:a[m],x:n,y:s}),r.fillText(a[m],n,s);return t},getPowerOfTwo:function(t,e){for(var i=e||1;t>i;)i*=2;return i},measureText:function(t,e){return t.measureText(e).width},createMultilineText:function(t,e,i,n){e=e.replace("\n"," ");var s,h,r,a,o=e,c=0,l=e.split(" ");for(r=a=l.length;this.measureText(t,o)>i&&r>1;){r--,o=s="";for(var u=0;a>u;u++)r>u?(o+=l[u],r>u+1&&(o+=" ")):(s+=l[u],a>u+1&&(s+=" "))}return n.push(o),h=this.measureText(t,o),s&&(c=this.createMultilineText(t,s,i,n),c>h&&(h=c)),h},draw:function(t){t.fillStyle=this.color,t.font=this.font,t.textAlign=this.textAlign||"left",t.textBaseline=this.textBaseline||"top",t.fillText(this.text,0,0)}}),e.Shape=e.DisplayObject.extend({ctor:function(t,e,i){this._super(),this.cmds=[],this.assMethod=["fillStyle","strokeStyle","lineWidth"],this.width=t,this.height=e,this._width=t,this._height=e,this.shapeCanvas=document.createElement("canvas"),this.shapeCanvas.width=this.width,this.shapeCanvas.height=this.height,this.shapeCtx=this.shapeCanvas.getContext("2d"),i&&(this.fillStyle("red"),this.fillRect(0,0,t,e)),this._watch(this,"scaleX",function(t,e){this.width=this._width*e,this.height=this._height*this.scaleY,this.shapeCanvas.width=this.width,this.shapeCanvas.height=this.height,this.shapeCtx.scale(e,this.scaleY),this.end()}),this._watch(this,"scaleY",function(t,e){this.width=this._width*this.scaleX,this.height=this._height*e,this.shapeCanvas.width=this.width,this.shapeCanvas.height=this.height,this.shapeCtx.scale(this.scaleX,e),this.end()})},end:function(){this._preCacheId=this.cacheID,this.cacheID=e.UID.getCacheID();for(var t=this.shapeCtx,i=0,n=this.cmds.length;n>i;i++){var s=this.cmds[i];this.assMethod.join("-").match(new RegExp("\\b"+s[0]+"\\b","g"))?t[s[0]]=s[1][0]:t[s[0]].apply(t,Array.prototype.slice.call(s[1]))}},clearRect:function(t,i,n,s){this.cacheID=e.UID.getCacheID(),this.shapeCtx.clearRect(t,i,n,s)},clear:function(){this.cacheID=e.UID.getCacheID(),this.cmds.length=0,this.shapeCtx.clearRect(0,0,this.width,this.height)},strokeRect:function(){return this.cmds.push(["strokeRect",arguments]),this},fillRect:function(){return this.cmds.push(["fillRect",arguments]),this},beginPath:function(){return this.cmds.push(["beginPath",arguments]),this},arc:function(){return this.cmds.push(["arc",arguments]),this},closePath:function(){return this.cmds.push(["closePath",arguments]),this},fillStyle:function(){return this.cmds.push(["fillStyle",arguments]),this},fill:function(){return this.cmds.push(["fill",arguments]),this},strokeStyle:function(){return this.cmds.push(["strokeStyle",arguments]),this},lineWidth:function(){return this.cmds.push(["lineWidth",arguments]),this},stroke:function(){return this.cmds.push(["stroke",arguments]),this},moveTo:function(){return this.cmds.push(["moveTo",arguments]),this},lineTo:function(){return this.cmds.push(["lineTo",arguments]),this},bezierCurveTo:function(){return this.cmds.push(["bezierCurveTo",arguments]),this},clone:function(){}}),e.Sprite=e.DisplayObject.extend({ctor:function(t){this._super(),this.option=t,this.x=t.x||0,this.y=t.y||0,this.currentFrameIndex=0,this.animationFrameIndex=0,this.currentAnimation=t.currentAnimation||null,this.rect=[0,0,10,10],this.visible=!1,this.bitmaps=[],this._loadedCount=0;for(var i=this.option.imgs.length,n=0;i>n;n++){var s=this.option.imgs[n];"string"==typeof s?e.Cache[s]?(this.bitmaps.push(new e.Bitmap(e.Cache[s])),this._loadedCount++):!function(){var t=new e.Bitmap;t._sprite=this,t.onImageLoad(function(){t._sprite._loadedCount++,t._sprite._loadedCount===i&&(t._sprite.visible=!0,delete t._sprite)}),t.useImage(this.option.imgs[n]),this.bitmaps.push(t)}():(this._loadedCount++,this.bitmaps.push(new e.Bitmap(s)))}this._loadedCount===i&&(this.visible=!0),this.img=this.bitmaps[0].img,this.interval=1e3/t.framerate,this.loop=null,this.paused=!1,this.animationEnd=t.animationEnd||null,this.currentAnimation&&this.gotoAndPlay(this.currentAnimation),this.tickAnimationEnd=t.tickAnimationEnd||null},play:function(){this.paused=!1},pause:function(){this.paused=!0},reset:function(){this.currentFrameIndex=0,this.animationFrameIndex=0},gotoAndPlay:function(t,e){this.paused=!1,this.reset(),clearInterval(this.loop),this.currentAnimation=t;var i=this,n=0;this.loop=setInterval(function(){if(!i.paused){var t=i.option,s=t.animations[i.currentAnimation].frames,h=s.length;i.animationFrameIndex++,i.animationFrameIndex>h-1&&(n++,i.animationFrameIndex=0,i.tickAnimationEnd&&i.tickAnimationEnd(),e&&n==e&&(i.animationEnd&&i.animationEnd(),i.paused=!0,clearInterval(i.loop),i.parent.remove(i))),i.rect=t.frames[s[i.animationFrameIndex]],i.width=i.rect[2],i.height=i.rect[3];var r=i.rect,a=r.length;a>4&&(i.regX=r[2]*r[4]),a>5&&(i.regY=r[3]*r[5]),a>6&&(i.img=i.bitmaps[r[6]].img)}},this.interval)},gotoAndStop:function(t){this.reset(),clearInterval(this.loop);var e=this;e.currentAnimation=t;var i=e.option,n=i.animations[e.currentAnimation].frames;e.rect=i.frames[n[e.animationFrameIndex]],e.width=e.rect[2],e.height=e.rect[3];var s=e.rect,h=s.length;h>4&&(e.regX=s[2]*s[4]),h>5&&(e.regY=s[3]*s[5]),h>6&&(e.img=e.bitmaps[s[6]].img)}}),e.Stage=e.Container.extend({ctor:function(t,i){this._super(),this.canvas="string"==typeof t?document.querySelector(t):t,this.width=this.canvas.width,this.height=this.canvas.height,this.AABB=[0,0,this.width,this.height],this.hitAABB=!0,this.hitRenderer=new e.CanvasRenderer,this.hitCanvas=document.createElement("canvas"),this.hitCanvas.width=1,this.hitCanvas.height=1,this.stageRenderer=new e.Renderer(this,i),this.hitCtx=this.hitCanvas.getContext("2d"),this._scaleX=this._scaleY=null,this.offset=this._getXY(this.canvas),this.overObj=null,this._paused=!1,this.fps=63,this.interval=Math.floor(1e3/this.fps),this.toList=[],this.tickFns=[],this.beginTick=null,this.endTick=null;var n=this;n.loop=setInterval(function(){n._paused||(n.beginTick&&n.beginTick(),n._tick(n),n.endTick&&n.endTick())},n.interval),Object.defineProperty(this,"useRequestAnimFrame",{set:function(t){this._useRequestAnimFrame=t,t?(clearInterval(n.loop),n.loop=e.RAF.requestInterval(function(){n._tick(n)},n.interval)):(e.RAF.clearRequestInterval(n.loop),n.loop=setInterval(function(){n._tick(n)},n.interval))},get:function(){return this._useRequestAnimFrame}}),this._watch(this,"fps",function(t,i){this.interval=Math.floor(1e3/i);var n=this;if(this.useRequestAnimFrame){clearInterval(this.loop);try{e.RAF.clearRequestInterval(this.loop)}catch(s){}this.loop=e.RAF.requestInterval(function(){n._tick(n)},this.interval)}else{e.RAF.clearRequestInterval(this.loop);try{clearInterval(this.loop)}catch(s){}this.loop=setInterval(function(){n._tick(n)},this.interval)}}),this._initDebug(),this._pressmoveObjs=null,this.baseInstanceof="Stage",this.overObj=null,this._moveInterval=16,this._preMoveTime=new Date,this._currentMoveTime=new Date,Object.defineProperty(this,"moveFPS",{set:function(t){this._moveFPS=t,this._moveInterval=1e3/t},get:function(){return this._moveFPS}}),this.canvas.addEventListener("mousemove",this._handleMouseMove.bind(this),!1),this.canvas.addEventListener("click",this._handleClick.bind(this),!1),this.canvas.addEventListener("mousedown",this._handleMouseDown.bind(this),!1),this.canvas.addEventListener("mouseup",this._handleMouseUp.bind(this),!1),this.canvas.addEventListener("dblclick",this._handleDblClick.bind(this),!1),this.addEvent(this.canvas,"mousewheel",this._handleMouseWheel.bind(this)),this.canvas.addEventListener("touchmove",this._handleMouseMove.bind(this),!1),this.canvas.addEventListener("touchstart",this._handleMouseDown.bind(this),!1),this.canvas.addEventListener("touchend",this._handleMouseUp.bind(this),!1),this.canvas.addEventListener("touchcancel",this._handleTouchCancel.bind(this),!1),document.addEventListener("DOMContentLoaded",this.adjustLayout.bind(this),!1),window.addEventListener("load",this.adjustLayout.bind(this),!1),window.addEventListener("resize",this.adjustLayout.bind(this),!1),this.autoUpdate=!0,this.scaleType="normal",this.setCursor(e.DefaultCursor)},adjustLayout:function(){this.offset=this._getXY(this.canvas),this.style=this._getStyle(),this._scaleX&&this.scaleToScreen(this._scaleX,this._scaleY)},pause:function(){this._paused=!0,this._pauseSprite(this),this._pauseTween()},play:function(){this._paused=!1,this._playSprite(this),this._playTween()},_pauseSprite:function(t){for(var i=0,n=t.children.length;n>i;i++){var s=t.children[i];s instanceof e.Container?this._pauseSprite(s):s instanceof e.Sprite&&s.pause()}},_pauseTween:function(){for(var t=0,e=this.toList.length;e>t;t++)this.toList[t].pause()},_playSprite:function(t){for(var i=0,n=t.children.length;n>i;i++){var s=t.children[i];s instanceof e.Container?this._playSprite(s):s instanceof e.Sprite&&s.play()}},_playTween:function(){for(var t=0,e=this.toList.length;e>t;t++)this.toList[t].play()},toggle:function(){this._paused?this.play():this.pause()},openDebug:function(){},closeDebug:function(){},_initDebug:function(){this.debugDiv=document.createElement("div"),this.debugDiv.style.cssText="display:none;position:absolute;z-index:2000;left:0;bottom:0;background-color:yellow;font-size:16px;",document.body.appendChild(this.debugDiv),Object.defineProperty(this,"debug",{set:function(t){this._debug=t,this._debug?this.debugDiv.style.display="block":this.debugDiv.style.display="none"},get:function(){return this._debug}})},_handleMouseWheel:function(t){this._correctionEvent(t,t.type);var e=this.events.mousewheel;if(e)for(var i=0,n=e.length;n>i;i++){var s=e[i];s(t)}this.overObj&&this.hitRenderer._bubbleEvent(this.overObj,"mousewheel",t)},update:function(){this.stageRenderer.update()},_correctionEvent:function(t,e){if(t.touches||t.changedTouches){var i=t.touches[0]||t.changedTouches[0];i&&(t.stageX=i.pageX,t.stageY=i.pageY)}else t.stageX=t.pageX,t.stageY=t.pageY;var n=this._correction(t.stageX,t.stageY);t.stageX=Math.round(n.x),t.stageY=Math.round(n.y);var s=this.events[e];if(s)for(var h=0,r=s.length;r>h;h++){var a=s[h];a(t)}},_handleClick:function(t){this._correctionEvent(t,t.type),this._getObjectUnderPoint(t,t.type)},_handleMouseMove:function(t){if(this._currentMoveTime=new Date,this._currentMoveTime-this._preMoveTime>this._moveInterval/2){if(this._correctionEvent(t,t.type),this._pressmoveObjs){var e=this._pressmoveObjs.events.pressmove;e&&this._pressmoveObjs.execEvent("pressmove",t)}var i=this._getObjectUnderPoint(t,"mousemove");i?this.overObj?(i.id!=this.overObj.id?(this.hitRenderer._bubbleEvent(this.overObj,"mouseout",t),this.hitRenderer._bubbleEvent(i,"mouseover",t),this.overObj=i):this.hitRenderer._bubbleEvent(i,"mousemove",t),this._setCursorByOverObject(i)):(this.overObj=i,this.hitRenderer._bubbleEvent(i,"mouseover",t)):this.overObj&&(this.hitRenderer._bubbleEvent(this.overObj,"mouseout",t),this.overObj=null),this._preMoveTime=this._currentMoveTime}},_getPressmoveTarget:function(t){t.events.pressmove&&(this._pressmoveObjs=t),t.parent&&this._getPressmoveTarget(t.parent)},_handleMouseDown:function(t){this._correctionEvent(t,"pressdown");var e=this._getObjectUnderPoint(t,"pressdown");e&&this._getPressmoveTarget(e)},_handleMouseUp:function(t){this._pressmoveObjs=null,this._correctionEvent(t,"pressup"),this._getObjectUnderPoint(t,"pressup")},_handleTouchCancel:function(t){this._pressmoveObjs=null,this._correctionEvent(t,"touchcancel"),this._getObjectUnderPoint(t,"touchcancel")},_handleDblClick:function(t){this._correctionEvent(t,t.type),this._getObjectUnderPoint(t,t.type)},_getObjectUnderPoint:function(t,e){return this.hitAABB?this.hitRenderer.hitAABB(this.hitCtx,this,t,e):this.hitRenderer.hitRender(this.hitCtx,this,t,e)},_getXY:function(t){var e=0,i=0;if(!document.documentElement.getBoundingClientRect||!t.getBoundingClientRect){for(;t.offsetParent;)e+=t.offsetTop,i+=t.offsetLeft,t=t.offsetParent;return[i,e]}var n=t.getBoundingClientRect();return i=n.left,e=n.top,[i+Math.max(document.documentElement.scrollLeft,document.body.scrollLeft),e+Math.max(document.documentElement.scrollTop,document.body.scrollTop)]},_tick:function(t){if(t&&t.tick&&t.tickFPS>0)if(this._initInterval(t),t.hasOwnProperty("_tickInterval")){t._tickIntervalCurrent=new Date,t._tickIntervalLast||(t._tickIntervalLast=new Date,t._tickIntervalPrev=new Date);var e=t._tickIntervalCurrent-t._tickIntervalLast+(t._tickIntervalCurrent-t._tickIntervalPrev);e>t._tickInterval&&(t.tick(),t._tickIntervalLast=t._tickIntervalCurrent),t._tickIntervalPrev=new Date}else t.tick();for(var i=t.children,n=i.length,s=0;n>s;s++){var h=i[s];if(h){if(h.tick&&h.tickFPS>0)if(this._initInterval(h),h.hasOwnProperty("_tickInterval")){h._tickIntervalCurrent=new Date,h._tickIntervalLast||(h._tickIntervalLast=new Date,h._tickIntervalPrev=new Date);var e=h._tickIntervalCurrent-h._tickIntervalLast+(h._tickIntervalCurrent-h._tickIntervalPrev);e>h._tickInterval&&(h.tick(),h._tickIntervalLast=h._tickIntervalCurrent),h._tickIntervalPrev=new Date}else h.tick();"Container"==h.baseInstanceof&&this._tick(h)}}},_initInterval:function(t){t.hasOwnProperty("tickFPS")&&(t._tickInterval=1e3/t.tickFPS)},tick:function(){for(var t=0,e=this.tickFns.length;e>t;t++){var i=this.tickFns[t];if(i.hasOwnProperty("_ARE_PrevDate")){i._ARE_CurrentDate=new Date;var n=i._ARE_CurrentDate-i._ARE_PrevDate+(i._ARE_CurrentDate-i._ARE_LastDate);n>i._ARE_Interval&&(i(),i._ARE_PrevDate=i._ARE_CurrentDate),i._ARE_LastDate=i._ARE_CurrentDate}else i()}this.autoUpdate&&this.update(),this.debug&&(this.getFPS(),
this.debugDiv.innerHTML="fps : "+this.fpsValue+" <br/>object count : "+this.getTotalCount()+" <br/>rendering mode : "+this.getRenderingMode()+" <br/>inner object count  : "+this.stageRenderer.objs.length)},onTick:function(t,e){this.tickFns.push(t),void 0!==e&&(t._ARE_PrevDate=new Date,t._ARE_CurrentDate=new Date,t._ARE_LastDate=new Date,t._ARE_Interval=e)},setFPS:function(t){this.interval=Math.floor(1e3/t)},onKeyboard:function(t,i,n){e.Keyboard.on(t,i,n)},getActiveKeys:function(){return e.Keyboard.getActiveKeys()},scaleToScreen:function(t,e){this.scaleType="screen",1===t&&1===e&&(document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden"),document.body.style.margin=0,document.documentElement.style.margin=0,document.body.style.border=0,document.documentElement.style.border=0,document.body.style.padding=0,document.documentElement.style.padding=0,document.body.style.width="100%",document.documentElement.style.width="100%",document.body.style.height="100%",document.documentElement.style.height="100%",this._scaleX=t,this._scaleY=e;var i=this.canvas;i.style.position="absolute",i.style.width=100*t+"%",i.style.height=100*e+"%",i.style.left=100*(1-t)/2+"%",i.style.top=100*(1-e)/2+"%",i.style.border="0px solid #ccc",this.offset=this._getXY(this.canvas),this.style=this._getStyle()},scaleToBox:function(t,e){this.scaleType="box",t===window.innerWidth&&e===window.innerHeight&&(document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden");var i=this.canvas;i.style.position="absolute",i.style.width=t+"px",i.style.height=e+"px",i.style.left=(window.innerWidth-t)/2+"px",i.style.top=(window.innerHeight-e)/2+"px",i.style.border="0px solid #ccc",this.offset=this._getXY(this.canvas),this.style=this._getStyle()},correctingXY:function(t,e){return"box"===this.scaleType?{x:t*this.width/parseInt(this.canvas.style.width),y:e*this.height/parseInt(this.canvas.style.height)}:{x:t*this.width/(window.innerWidth*this._scaleX),y:e*this.height/(window.innerHeight*this._scaleY)}},getTotalCount:function(){function t(n){if("Container"==n.baseInstanceof||"Stage"==n.baseInstanceof)for(var s=0,h=n.children.length;h>s;s++){var r=n.children[s];r instanceof e.Container?t(r):i++}else i++}var i=0;return t(this),i},getRenderingMode:function(){return this.stageRenderer.renderingEngine instanceof e.CanvasRenderer?"Canvas":"WebGL"},getFPS:function(){},addEvent:function(t,e,i,n){"mousewheel"===e&&void 0!==document.mozHidden&&(e="DOMMouseScroll"),t.addEventListener(e,function(t){var e=t.type;"DOMMouseScroll"!=e&&"mousewheel"!=e||(t.delta=t.wheelDelta?t.wheelDelta/120:-(t.detail||0)/3),i.call(this,t)},n||!1)},setCursor:function(t){this.canvas.style.cursor=t},_setCursorByOverObject:function(t){"default"!==t.cursor?this.setCursor(t.cursor):t.parent&&this._setCursorByOverObject(t.parent)},destroy:function(){this._super(),this.canvas.parentNode.removeChild(this.canvas),this.useRequestAnimFrame?e.RAF.clearRequestInterval(this.loop):clearInterval(this.loop)},_getStyle:function(){var t=window.getComputedStyle(this.canvas,null);return{boxSizing:t.boxSizing,borderTopWidth:parseInt(t.borderTopWidth),borderLeftWidth:parseInt(t.borderLeftWidth),width:parseInt(t.width),height:parseInt(t.height)}},_correction:function(t,e){var i=t-this.offset[0]-this.style.borderLeftWidth,n=e-this.offset[1]-this.style.borderTopWidth,s=this.style.width,h=this.style.height;return"border-box"===this.style.boxSizing&&(s-=this.style.borderLeftWidth,h-=this.style.borderTopWidth),{x:this.width*i/s,y:this.height*n/h}}}),e.Text=e.DisplayObject.extend({ctor:function(t,e,i){this._super(),this.value=t,this.font=e,this.color=i,this.textAlign="left",this.textBaseline="top"},draw:function(t){t.fillStyle=this.color,t.font=this.font,t.textAlign=this.textAlign||"left",t.textBaseline=this.textBaseline||"top",t.fillText(this.value,0,0)},clone:function(){var t=new e.Text(this.text,this.font,this.color);return this.cloneProps(t),t},getWidth:function(){var t=document.createElement("canvas").getContext("2d");t.font=this.font;var e=t.measureText(this.value).width;return t=null,e}}),e});